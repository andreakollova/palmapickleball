<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin – Zákazníci</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --accent:#3a38d6;
      --ink:#111827;
      --muted:#667085;
      --border:#e7e9ef;
      --shadow:0 6px 24px rgba(16,24,40,.06);
      --radius:12px;
      --ok:#16a34a;
      --sidebar:250px;
      --member-bg:#3a38d6;
      --staff-bg:#111827;
    }

    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--ink);
      background:#fff;
    }

    /* Top bar */
    .topbar{
      position:sticky;
      top:0;
      z-index:40;
      background:#fff;
      border-bottom:1px solid var(--border);
      padding:10px 16px;
    }
    .tb{
      max-width:1200px;
      margin:0 auto;
      padding:0 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--ink);
      text-decoration:none;
    }
    .brand img{height:30px}
    .title-strong{
      font-weight:800;
      letter-spacing:.01em;
    }
    .btn-top{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:.48rem .9rem;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--ink);
      text-decoration:none;
      font-weight:500;
      line-height:1.15;
      cursor:pointer;
    }
    .btn-top:hover{filter:brightness(.98)}

    /* Layout grid */
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:18px 12px;
      display:grid;
      gap:18px;
      grid-template-columns:var(--sidebar) 1fr;
    }
    @media(max-width:992px){
      .wrap{grid-template-columns:1fr}
    }

    /* Sidebar */
    .side{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      box-shadow:var(--shadow);
      padding:14px;
      position:sticky;
      top:72px;
      height:fit-content;
    }
    .side h3{
      margin:0 0 8px 0;
      font-size:1.05rem;
      font-weight:750;
    }
    .nav{list-style:none;margin:0;padding:0}
    .nav a{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:10px;
      text-decoration:none;
      color:var(--ink);
      border:1px solid transparent;
    }
    .nav a:hover{background:#fafbff;border-color:#eef0f5}
    .nav a.active{background:#f3f4ff;border-color:#dfe1ff;color:#2b2acb}
    .ico{
      width:16px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }

    /* Card container */
    .card{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    /* Header of card */
    .card-head{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      padding:16px;
      border-bottom:1px solid var(--border);
      gap:12px;
    }

    .head-left{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      gap:12px 10px;
    }

    .list-title{
      font-size:1.2rem;
      font-weight:650;          /* jemnejšie */
      letter-spacing:-0.02em;
      color:var(--ink);
      line-height:1.2;
    }

    .pills{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .pill-btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:6px 12px;
      font-size:0.9rem;
      font-weight:500;
      color:var(--ink);
      cursor:pointer;
      line-height:1.2;
      transition:background .15s;
    }
    .pill-btn.active{
      background:#f3f4f6;
      border-color:#d1d5db;
    }

    .head-right{
      display:flex;
      flex-wrap:nowrap;
      align-items:flex-start;
      gap:8px;
      margin-left:auto;
    }

    .search-box{
      position:relative;
      display:flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px 10px;
      background:#fff;
    }
    .search-box i{
      font-size:0.9rem;
      color:var(--muted);
    }
    .search-input{
      border:0;
      outline:0;
      font:inherit;
      font-size:0.9rem;
      color:var(--ink);
      min-width:140px;
    }

    /* Body wrapper */
    .card-body{
      padding:12px 16px 16px;
      display:flex;
      flex-direction:column;
    }

    /* ROW LAYOUT
       desktop:
       num | avatar+meno/uroven | kontakty | rola
    */
    .cust-row{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px 16px;
      display:grid;
      align-items:center;           /* <-- center vertically whole row content */
      gap:12px 16px;
      grid-template-columns:
        40px
        minmax(200px,1fr)
        minmax(260px,1.2fr)
        auto;
    }

    .cust-row + .cust-row{margin-top:10px}

    /* mobile layout */
    @media(max-width:780px){
      .cust-row{
        grid-template-columns:40px minmax(0,1fr) auto;
        grid-template-areas:
          "num main role"
          "num meta role";
      }
    }

    /* číslo */
    .cust-num{
      width:36px;
      height:36px;
      border-radius:999px;
      border:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:400;
      font-size:.95rem;
      color:var(--ink);
    }
    @media(max-width:780px){
      .cust-num{grid-area:num;}
    }

    /* ľavý blok: avatar + meno + level pod tým */
    .cust-mainwrap{
      display:flex;
      align-items:flex-start;
      gap:12px;
      min-width:0;
    }
    @media(max-width:780px){
      .cust-mainwrap{grid-area:main;}
    }

    .cust-ava-wrap{
      position:relative;
      width:48px;
      height:48px;
      flex:0 0 48px;
    }
    .cust-ava{
      width:48px;
      height:48px;
      border-radius:999px;
      object-fit:cover;
      border:1px solid #eef0f5;
      background:#f6f7fb;
    }
    .cust-badge-mark{
      position:absolute;
      left:-6px;
      bottom:-6px;
      width:24px;
      height:24px;
      object-fit:contain;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,.15));
      pointer-events:none;
    }

    .cust-ident{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .cust-name{
      font-size:1rem;
      font-weight:700;
      color:var(--ink);
      line-height:1.3;
      word-break:break-word;
    }

    .cust-level{
      font-size:.78rem;              /* menšie */
      line-height:1.3;
      color:#475467;
      background:#f6f7fb;
      border:1px solid #dfe3ea;
      border-radius:999px;
      display:inline-block;
      padding:3px 7px;
      width:max-content;
    }

    /* stredný blok: kontakty menší text + registrovaný */
    .cust-mid{
      min-width:0;
      display:flex;
      flex-direction:column;
      justify-content:center;        /* <-- center vertically this block */
      gap:4px;
      font-size:.85rem;              /* menšie */
      line-height:1.4;
      color:var(--muted);
    }
    @media(max-width:780px){
      .cust-mid{
        grid-area:meta;
        font-size:.85rem;
      }
    }

    .cust-contact-line{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      color:var(--muted);
      word-break:break-word;
      font-size:.85rem;              /* menšie */
    }
    .cust-contact-line span{
      white-space:nowrap;
    }

    .cust-registered{
      font-size:.75rem;
      line-height:1.3;
      color:#98a2b3;
    }

    /* pravý blok: rola select + uložiť */
    .cust-rolewrap{
      display:flex;
      flex-wrap:nowrap;
      align-items:flex-start;
      gap:8px;
      justify-self:flex-end;
    }
    @media(max-width:780px){
      .cust-rolewrap{
        grid-area:role;
        flex-direction:column;
        align-items:flex-end;
        gap:6px;
      }
    }

    .role-select{
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      padding:8px 10px;
      font-size:.9rem;
      font-family:inherit;
      min-width:130px;
      cursor:pointer;
      line-height:1.2;
      appearance:none;

      /* default caret (dark) */
      background-image:
        linear-gradient(45deg, transparent 50%, #111 50%),
        linear-gradient(135deg, #111 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% - 2px),
        calc(100% - 14px) calc(50% + 2px);
      background-size:4px 4px,4px 4px;
      background-repeat:no-repeat;
      color:var(--ink);
    }

    /* farebné varianty role */
    .role-select.is-member{
      background:var(--member-bg);
      border-color:var(--member-bg);
      color:#fff;

      /* caret becomes white */
      background-image:
        linear-gradient(45deg, transparent 50%, #fff 50%),
        linear-gradient(135deg, #fff 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% - 2px),
        calc(100% - 14px) calc(50% + 2px);
      background-size:4px 4px,4px 4px;
      background-repeat:no-repeat;
    }
    .role-select.is-staff{
      background:var(--staff-bg);
      border-color:var(--staff-bg);
      color:#fff;

      /* caret becomes white */
      background-image:
        linear-gradient(45deg, transparent 50%, #fff 50%),
        linear-gradient(135deg, #fff 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% - 2px),
        calc(100% - 14px) calc(50% + 2px);
      background-size:4px 4px,4px 4px;
      background-repeat:no-repeat;
    }

    .save-btn{
      width:32px;
      height:32px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--ok);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.9rem;
      cursor:pointer;
    }

    /* Pagination */
    .pagination{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:6px;
      margin:20px 0 0;
      flex-wrap:wrap;
    }
    .page-btn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--ink);
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      min-width:36px;
      text-align:center;
    }
    .page-btn[disabled]{opacity:.45;cursor:not-allowed}
    .page-btn.active{background:#111;color:#fff;border-color:#111}

    /* Toast */
    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      background:#16a34a;
      color:#fff;
      padding:.7rem 1rem;
      border-radius:12px;
      box-shadow:0 10px 24px rgba(0,0,0,.12);
      opacity:0;
      transform:translateY(8px);
      pointer-events:none;
      transition:.18s ease;
      font-size:.9rem;
      font-weight:500;
    }
    .toast.show{
      opacity:1;
      transform:translateY(0);
    }
  </style>
</head>
<body>

  <!-- Top nav -->
  <header class="topbar">
    <div class="tb">
      <a class="brand" href="#">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Palma Pickleball">
        <span class="title-strong">Palma Admin</span>
      </a>
      <div class="tb-actions">
        <a class="btn-top" href="{{ url_for('index') }}">Domov</a>
        <a class="btn-top" href="/adminpanel">Odhlásiť</a>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- sidebar -->
    {% include "partials/admin_sidebar.html" %}

    <!-- main card -->
    <main class="card">
      <!-- header -->
      <div class="card-head">
        <div class="head-left">
          <div class="list-title">Zákazníci</div>

          <div class="pills" id="custFilters">
            <button class="pill-btn active" data-role="all">Všetci</button>
            <button class="pill-btn" data-role="none">Nie je člen</button>
            <button class="pill-btn" data-role="clen">Člen</button>
            <button class="pill-btn" data-role="staff">Staff</button>
          </div>
        </div>

        <div class="head-right">
          <div class="search-box">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input class="search-input" id="searchInput" type="text" placeholder="Hľadaj…" />
          </div>
        </div>
      </div>

      <!-- list -->
      <div class="card-body">
        <div id="custList">
          {# zoradíme podľa registered_at: newest first #}
          {% set ordered = reservations|sort(attribute='registered_at', reverse=True) %}
          {% set total   = ordered|length %}

          {% for u in ordered %}
            {% set display_num = total - loop.index0 %}

            {# badge podľa statusu #}
            {% if u.status == 'clen' %}
              {% set badge_src = url_for('static', filename='images/badges/clen.png') %}
            {% elif u.status == 'staff' %}
              {% set badge_src = url_for('static', filename='images/badges/staff.png') %}
            {% else %}
              {% set badge_src = None %}
            {% endif %}

            {# pekný dátum registrácie DD.MM.YYYY #}
            {% set reg_raw = u.registered_at or '' %}
            {% if reg_raw|length >= 10 and '-' in reg_raw %}
              {% set ry = reg_raw[0:4] %}
              {% set rm = reg_raw[5:7] %}
              {% set rd = reg_raw[8:10] %}
              {% set reg_nice = rd ~ '.' ~ rm ~ '.' ~ ry %}
            {% else %}
              {% set reg_nice = reg_raw %}
            {% endif %}

            {# role class pre farbu selectu #}
            {% if u.status == 'clen' %}
              {% set role_class = 'is-member' %}
            {% elif u.status == 'staff' %}
              {% set role_class = 'is-staff' %}
            {% else %}
              {% set role_class = '' %}
            {% endif %}

            <article class="cust-row"
              data-status="{{ u.status or 'none' }}"
              data-search="{{ (u.name ~ ' ' ~ u.email ~ ' ' ~ u.phone ~ ' ' ~ (u.level or '')) | lower }}">

              <!-- číslo -->
              <div class="cust-num">{{ display_num }}</div>

              <!-- meno / avatar / level under name -->
              <div class="cust-mainwrap">
                <div class="cust-ava-wrap">
                  <img class="cust-ava" src="{{ u.avatar or url_for('static', filename='images/profile1.png') }}" alt="avatar">
                  {% if badge_src %}
                    <img class="cust-badge-mark" src="{{ badge_src }}" alt="{{ u.status }}">
                  {% endif %}
                </div>

                <div class="cust-ident">
                  <div class="cust-name">{{ u.name }}</div>
                  {% if u.level %}
                    <div class="cust-level">{{ u.level }}</div>
                  {% endif %}
                </div>
              </div>

              <!-- kontakty / dátum -->
              <div class="cust-mid">
                <div class="cust-contact-line">
                  {% if u.email %}
                    <span>{{ u.email }}</span>
                  {% endif %}
                  {% if u.phone %}
                    <span>{{ u.phone }}</span>
                  {% endif %}
                </div>
                <div class="cust-registered">
                  Registrovaný: {{ reg_nice }}
                </div>
              </div>

              <!-- rola -->
              <div class="cust-rolewrap">
                <select class="role-select {{ role_class }}">
                  <option value="none"  {{ 'selected' if u.status not in ['clen','staff'] else '' }}>Nie je člen</option>
                  <option value="clen"  {{ 'selected' if u.status == 'clen'  else '' }}>Člen</option>
                  <option value="staff" {{ 'selected' if u.status == 'staff' else '' }}>Staff</option>
                </select>
                <button class="save-btn" title="Uložiť">
                  <i class="fa-solid fa-check"></i>
                </button>
              </div>
            </article>
          {% endfor %}
        </div>

        <!-- pagination -->
        <div class="pagination" id="pager"></div>
      </div>
    </main>
  </div>

  <div id="toast" class="toast">Uložené</div>

  <script>
    const toast = document.getElementById('toast');
    function showToast(msg){
      toast.textContent = msg || 'Uložené';
      toast.classList.add('show');
      clearTimeout(window.__tid);
      window.__tid = setTimeout(()=>toast.classList.remove('show'), 1600);
    }

    // uloženie roly (demo toast)
    document.addEventListener('click', e=>{
      if(e.target.closest('.save-btn')){
        showToast('Uložené');
      }
    });

    // keď admin zmení rolu v selecte, zafarbíme ho (len FE demo)
    document.addEventListener('change', e=>{
      const sel = e.target.closest('.role-select');
      if(!sel) return;
      sel.classList.remove('is-member','is-staff');
      if(sel.value === 'clen'){
        sel.classList.add('is-member');
      } else if(sel.value === 'staff'){
        sel.classList.add('is-staff');
      }
    });

    // pri načítaní stránky: nastaviť správnu farbu pre všetky selecty podľa ich value
    window.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.role-select').forEach(sel=>{
        sel.classList.remove('is-member','is-staff');
        if(sel.value === 'clen'){
          sel.classList.add('is-member');
        } else if(sel.value === 'staff'){
          sel.classList.add('is-staff');
        }
      });
    });

    // filter + search + pagination
    (function(){
      const listEl   = document.getElementById('custList');
      const pagerEl  = document.getElementById('pager');
      const pillsBox = document.getElementById('custFilters');
      const searchIn = document.getElementById('searchInput');

      const PER_PAGE = 10;
      let curPage = 1;
      let activeFilter = 'all';
      let term = '';

      function rows(){
        return Array.from(listEl.querySelectorAll('.cust-row'));
      }

      function applyFilterSearch(){
        const tnorm = term.trim().toLowerCase();

        rows().forEach(row=>{
          const rowRole   = row.getAttribute('data-status') || 'none';
          const rowSearch = row.getAttribute('data-search') || '';

          // filter role
          let ok = (activeFilter === 'all') || (rowRole === activeFilter);

          // search
          if(ok && tnorm){
            ok = rowSearch.includes(tnorm);
          }

          row.style.display = ok ? '' : 'none';
        });

        curPage = 1;
        repaginate();
      }

      // pagination utils
      function visibleRows(){
        return rows().filter(r => r.style.display !== 'none');
      }

      function renderPager(){
        const vis = visibleRows();
        const pages = Math.max(1, Math.ceil(vis.length / PER_PAGE));
        if(curPage > pages) curPage = pages;

        pagerEl.innerHTML = '';

        pagerEl.insertAdjacentHTML('beforeend',
          `<button class="page-btn" data-nav="prev" ${curPage===1?'disabled':''}>‹</button>`
        );

        for(let p=1;p<=pages;p++){
          pagerEl.insertAdjacentHTML('beforeend',
            `<button class="page-btn ${p===curPage?'active':''}" data-page="${p}">${p}</button>`
          );
        }

        pagerEl.insertAdjacentHTML('beforeend',
          `<button class="page-btn" data-nav="next" ${curPage===pages?'disabled':''}>›</button>`
        );
      }

      function applyPage(){
        const vis = visibleRows();
        const start = (curPage-1)*PER_PAGE;
        const end   = curPage*PER_PAGE;

        // reset all inline pagination styles first
        rows().forEach(r=>{
          r.style.visibility   = '';
          r.style.position     = '';
          r.style.pointerEvents= '';
          r.style.height       = '';
          r.style.marginTop    = '';
        });

        vis.forEach((row,i)=>{
          const show = i>=start && i<end;
          if(!show){
            row.style.visibility    = 'hidden';
            row.style.position      = 'absolute';
            row.style.pointerEvents = 'none';
            row.style.height        = '0';
            row.style.marginTop     = '0';
          }
        });
      }

      function repaginate(){
        renderPager();
        applyPage();
      }

      pagerEl.addEventListener('click', e=>{
        const btn = e.target.closest('.page-btn');
        if(!btn) return;
        if(btn.dataset.page){
          curPage = parseInt(btn.dataset.page,10);
        }else if(btn.dataset.nav === 'prev'){
          curPage = Math.max(1, curPage-1);
        }else if(btn.dataset.nav === 'next'){
          curPage = curPage+1;
        }
        repaginate();
      });

      // pills click
      pillsBox.addEventListener('click', e=>{
        const pill = e.target.closest('.pill-btn');
        if(!pill) return;
        activeFilter = pill.dataset.role;
        Array.from(pillsBox.querySelectorAll('.pill-btn')).forEach(b=>{
          b.classList.toggle('active', b===pill);
        });
        applyFilterSearch();
      });

      // live search
      searchIn.addEventListener('input', e=>{
        term = e.target.value || '';
        applyFilterSearch();
      });

      // init
      applyFilterSearch();
    })();
  </script>
</body>
</html>
