{% extends "base.html" %}
{% block content %}
<style>
  :root{
    --ink:#0b0f14;
    --muted:#667085;
    --line:#e6eaee;
    --bg:#ffffff;
    --panel:#ffffff;
    --soft:#f7f9fb;
    --soft-2:#f3f6f8;
    --shadow:0 12px 36px rgba(9,16,28,.10);
    --shadow-sm:0 8px 22px rgba(9,16,28,.08);
    --radius:16px;
    --r-lg:22px;
    --green:#0F7A4A;
    --green-2:#0b5d39;
    --ok:#16a34a;
    --danger:#b42318;
    --orange:#c97710;
    --red:#b42318;
  }

  .page-wrap{ max-width:1200px; margin:24px auto 36px; padding:0 16px; }

  /* ===== HERO ===== */
  .hero{
    position:relative; border:1px solid var(--line); border-radius:22px;
    overflow:hidden; box-shadow:var(--shadow);
    background:url("{{ url_for('static', filename='images/kurt.png') }}") center/cover;
  }
  .hero::before{
    content:""; position:absolute; inset:0;
    background:
      radial-gradient(1200px 500px at 60% 50%, rgba(0,0,0,.18), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
    pointer-events:none;
  }
  .hero-inner{
    position:relative; z-index:1;
    padding:44px 26px 56px;
    display:grid; grid-template-columns: 1fr 440px; gap:18px; align-items:center;
  }
  @media (max-width: 980px){ .hero-inner{ grid-template-columns:1fr; padding:36px 20px; } }

  .eyebrow{
    display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:999px;
    border:1px solid rgba(255,255,255,.28); color:#fff; background:rgba(255,255,255,.08);
    font-weight:600; letter-spacing:.02em; font-size:.82rem;
  }
  .h1{
    color:#fff; font-weight:800; line-height:1.04; letter-spacing:-.02em;
    font-size:clamp(1.8rem,3vw,2.7rem);
    margin:10px 0 8px;
  }
  .h-sub{ color:#e8f1ec; font-size:clamp(.9rem,1.15vw,1rem); max-width:58ch; }
  .hero-cta{ margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; }

  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:10px;
    padding:8px 12px; border-radius:12px; border:1px solid var(--line);
    background:#fff; color:#fff; text-decoration:none; font-weight:700; cursor:pointer; transition:.16s ease;
    font-size:.92rem;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow-sm); }
  .btn-ghost{ background:transparent; color:#fff; border-color:rgba(255,255,255,.35); }
  .btn-ghost:hover{ background:rgba(255,255,255,.06); }
  .btn-accent{ background:#111; color:#fff; border-color:#111; }
  .btn-accent:hover{ background:#000; border-color:#000; }
  .btn-green{ background:var(--green); border-color:var(--green); color:#fff; }
  .btn-green:hover{ background:var(--green-2); border-color:var(--green-2); }
  .btn-sm{ padding:6px 10px; border-radius:10px; font-weight:700; font-size:.9rem; }

  /* Hero right panel = inline creator */
  .creator{
    width:100%; max-width:440px; background:#fffffff0; border:1px solid var(--line);
    border-radius:18px; padding:14px; box-shadow:var(--shadow);
    backdrop-filter:saturate(1.2);
  }
  .c-head{ font-weight:800; letter-spacing:-.01em; color:var(--ink); padding:2px 6px 10px; font-size:1rem; }
  .field{ margin-bottom:12px; }
  .label{ font-size:.88rem; color:#1b1f24; font-weight:800; margin-bottom:6px; }
  .input, .select{
    width:100%; border:1px solid var(--line); border-radius:12px; padding:8px 11px; font:inherit; background:#fff; font-size:.94rem;
  }

  .court-tabs{ display:flex; gap:8px; }
  .tab{
    border:1px solid var(--line); border-radius:999px; padding:7px 12px; background:#fff; font-weight:800; cursor:pointer;
    color:#0b0f14; font-size:.9rem;
  }
  .tab.active{ background:#111; color:#fff; border-color:#111; }

  .time-scroll{
    display:flex; gap:8px; overflow-x:auto; padding:2px 2px 6px; scroll-snap-type:x mandatory;
  }
  .time-pill{
    scroll-snap-align:start;
    border:1px solid var(--line); border-radius:999px; padding:7px 11px; background:#fff; font-weight:800; cursor:pointer; white-space:nowrap;
    color:#0b0f14; font-size:.9rem;
  }
  .time-pill.sel{ background:#111; color:#fff; border-color:#111; }
  .time-pill.muted{ opacity:.45; cursor:not-allowed; text-decoration:line-through; }

  .quarter-select{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
  .q-btn{
    border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#fff; font-weight:800; cursor:pointer; width:100%; color:#0b0f14; font-size:.9rem;
  }
  .q-btn.sel{ background:var(--soft); border-color:#dfe6ec; }

  .create-foot{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding-top:8px; border-top:1px dashed #e9eef3; }
  .help-sm{ color:var(--muted); font-size:.88rem; }

  /* ===== SECTION HEADS ===== */
  .section{ margin-top:26px; }
  .section-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:2px 4px 12px; }
  .title{ font-weight:800; letter-spacing:-.02em; color:var(--ink); font-size:clamp(1.1rem,1.4vw,1.35rem); display:flex; align-items:center; gap:10px; }
  .chip{ padding:4px 9px; border-radius:999px; border:1px solid var(--line); background:var(--soft); color:#2a2f38; font-weight:700; font-size:.78rem; }
  .filters{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .f-pill{ border:1px solid var(--line); border-radius:999px; padding:6px 10px; background:#fff; font-weight:800; cursor:pointer; color:#0b0f14; font-size:.9rem; }
  .f-pill.active{ background:#111; color:#fff; border-color:#111; }

  /* ===== ACTIVE PARTIES STRIP ===== */
  .active-strip{ display:grid; grid-template-columns:repeat(12,1fr); gap:14px; }
  .party{ grid-column:span 3; background:#fff; border:1px solid var(--line); border-radius:18px; overflow:hidden; box-shadow:var(--shadow-sm); display:grid; grid-template-rows:auto 1fr; }
  @media (max-width:980px){ .party{ grid-column:1/-1; } }
  .party-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-bottom:1px solid var(--line); }
  .p-title{
    font-weight:800; letter-spacing:-.01em; color:var(--ink);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    font-size:.98rem;
  }
  .p-meta{
    color:var(--muted); font-weight:600;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    font-size:.9rem;
  }
  .p-cta{ display:flex; gap:8px; align-items:center; }

  .chip-state{
    display:inline-flex; align-items:center; gap:8px; padding:5px 9px; border-radius:999px; border:1px solid var(--line); font-weight:800;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:.8rem;
  }
  .chip-state .dot{ width:8px; height:8px; border-radius:999px; }
  .chip-ok{ background:#eef7f1; color:var(--green); border-color:#dfeee6; }
  .chip-ok .dot{ background:var(--green); }
  .chip-warn{ background:#fff6ed; color:var(--orange); border-color:#f6e3ce; }
  .chip-warn .dot{ background:var(--orange); }
  .chip-bad{ background:#fef3f2; color:var(--red); border-color:#f8d2cf; }
  .chip-bad .dot{ background:var(--red); }

  .badge{ display:inline-flex; align-items:center; justify-content:center; min-width:24px; height:24px; padding:0 8px; background:#f5f7fa; color:#0e1217; border:1px solid var(--line); border-radius:999px; font-weight:800; font-size:.78rem; }

  /* ======= COURT IMAGE – FIX: FULL, NOT CROPPED ======= */
  .court-wrap{
    position:relative;
    background:var(--soft);
    /* Presný pomer kurt.png (1162×768 ≈ 1.514) – žiadne odrezanie */
    aspect-ratio: 1162 / 768;
    height:auto;
    overflow:visible;
  }
  .court-img{
    position:absolute; inset:0;
    background:
      url("{{ url_for('static', filename='images/kurt.png') }}")
      center / contain no-repeat;        /* ukáže celý kurt */
    background-color:var(--soft);        /* letterbox pásy */
    filter: drop-shadow(0 8px 18px rgba(0,0,0,.08));
  }

  /* quarters + UI nad kurtom (nezmenené) */
  .q{ position:absolute; border-radius:10px; outline:1px dashed rgba(15,15,20,.08); inset:8px calc(50% + 6px) calc(50% + 6px) 8px; }
  .q[data-q="2"]{ inset:8px 8px calc(50% + 6px) calc(50% + 6px); }
  .q[data-q="3"]{ inset:calc(50% + 6px) calc(50% + 6px) 8px 8px; }
  .q[data-q="4"]{ inset:calc(50% + 6px) 8px 8px calc(50% + 6px); }
  .q.past{ filter:saturate(.15) grayscale(.6); background:#f3f4f6; cursor:not-allowed; }

  .plus{ position:absolute; right:9px; bottom:9px; width:30px; height:30px; border-radius:999px; display:flex; align-items:center; justify-content:center; background:#fff; border:1px solid var(--line); color:#111; font-weight:900; cursor:pointer; box-shadow:0 8px 18px rgba(16,24,40,.10); transition:.14s ease; z-index:2; }
  .plus:hover{ transform:translateY(-1px); }

  .slots{ position:absolute; inset:10px; display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr; gap:8px; pointer-events:none; }
  .slot{ position:relative; }
  .pile{ position:absolute; left:8px; top:8px; display:flex; }
  .pp{ width:32px; height:32px; border-radius:999px; object-fit:cover; border:2px solid #fff; box-shadow:0 6px 12px rgba(0,0,0,.12); }
  .pile .pp + .pp{ margin-left:-10px; }
  .level{ position:absolute; left:8px; bottom:8px; padding:3px 7px; border-radius:999px; background:#fff; border:1px solid var(--line); font-weight:800; font-size:.68rem; color:#1b1f24; }

  .pop{
    position:absolute; z-index:9; transform:translate(-50%,-8px); min-width:220px; max-width:280px;
    background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px; box-shadow:var(--shadow);
    opacity:0; pointer-events:none; transition:.12s ease;
  }
  .pop.show{ opacity:1; pointer-events:auto; transform:translate(-50%,0); }
  .pop .p-title{ font-weight:900; font-size:.98rem;}
  .pop .p-sub{ color:var(--muted); font-size:.88rem; }
  .pop .row{ display:flex; align-items:center; gap:10px; margin:8px 0 12px; }
  .pop .row img{ width:32px;height:32px;border-radius:999px; object-fit:cover; }
  .pop .act{ display:flex; gap:8px; }

  .muted-card{ filter:saturate(.35) grayscale(.35); }

  /* pagination */
  .pager{ display:flex; align-items:center; gap:8px; justify-content:center; margin-top:12px; }
  .pgbtn{
    border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:10px; cursor:pointer; min-width:34px; text-align:center; font-weight:800; font-size:.9rem;
  }
  .pgbtn.active{ background:#111; color:#fff; border-color:#111; }
  .pgbtn[disabled]{ opacity:.45; cursor:not-allowed; }

  /* Toast */
  .toast{ position:fixed; right:16px; bottom:16px; background:#111; color:#fff; padding:.72rem .95rem; border-radius:12px; box-shadow:var(--shadow); opacity:0; transform:translateY(6px); pointer-events:none; transition:.16s ease; font-weight:800; font-size:.92rem; }
  .toast.show{ opacity:1; transform:translateY(0); }
</style>

<div class="page-wrap">

  <!-- HERO -->
  <section class="hero">
    <div class="hero-inner">
      <div>
        <span class="eyebrow">Komunita hrá spolu</span>
        <h1 class="h1">Pridaj sa k partii alebo založ novú.</h1>
        <p class="h-sub">Rýchle pripojenie k rozbehnutým hrám. Štýlový prehľad kurtov a členov.
          Jedno kliknutie, žiadne formuláre. Všetko v minimalistickom, čistom dizajne.</p>

        <div class="hero-cta">
          <a class="btn btn-green" href="#active">Pozri aktívne partie</a>
        </div>
      </div>

      <!-- Inline Creator -->
      <div class="creator" id="creator">
        <div class="c-head">Vytvoriť partičku</div>

        <div class="field">
          <div class="label">Dátum</div>
          <input class="input" type="date" id="cDate" min="">
        </div>

        <div class="field">
          <div class="label">Kurt</div>
          <div class="court-tabs" id="cCourts">
            <button class="tab active" data-c="1">Kurt 1</button>
            <button class="tab" data-c="2">Kurt 2</button>
          </div>
        </div>

        <div class="field">
          <div class="label">Čas</div>
          <div class="time-scroll" id="cTimes">
            <!-- pills via JS -->
          </div>
        </div>

        <div class="field">
          <div class="label">Štvrťka</div>
          <div class="quarter-select" id="cQuarters">
            <button class="q-btn sel" data-q="1">1</button>
            <button class="q-btn" data-q="2">2</button>
            <button class="q-btn" data-q="3">3</button>
            <button class="q-btn" data-q="4">4</button>
          </div>
        </div>

        <div class="create-foot">
          <div class="help-sm">Len prihlásení sa môžu pridať. <a href="/login">Prihlásiť / registrovať</a></div>
          <button class="btn btn-accent btn-sm" id="cCreate">Založiť</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ACTIVE PARTIES -->
  <section class="section" id="active">
    <div class="section-head">
      <div class="title">Aktívne partie teraz <span class="chip" id="activeCount">0</span></div>
      <div class="filters">
        <button class="f-pill active" data-filter="all">Všetky</button>
        <button class="f-pill" data-filter="today">Dnes</button>
        <button class="f-pill" data-filter="tomorrow">Zajtra</button>
        <input class="select" style="width:auto" type="date" id="filterDate">
      </div>
    </div>

    <div class="active-strip" id="activeStrip"><!-- cards --></div>
    <div class="pager" id="pager"><!-- pagination --></div>
  </section>
</div>

<!-- Toast -->
<div class="toast" id="toast">Hotovo</div>

<script>
(function(){
  const currentUser = {
    id:'u-self',
    name:'Andrea',
    avatar:"{{ url_for('static', filename='images/profile1.png') }}",
    level:'M4'
  };

  const $ = (sel,root=document)=>root.querySelector(sel);
  const $$ = (sel,root=document)=>[...root.querySelectorAll(sel)];
  const el = (html)=>{const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstChild;};
  const pad = n=>n<10?'0'+n:''+n;
  const toISO = (d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const nice = iso=>{const d=new Date(iso); return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;};
  const toast = (m)=>{ const t=$("#toast"); t.textContent=m||'Hotovo'; t.classList.add('show'); clearTimeout(window.__tt); window.__tt=setTimeout(()=>t.classList.remove('show'),1400); };
  const now = new Date();

  function parseRange(r){ const m=String(r).match(/(\d{2}):(\d{2})\s*[–-]\s*(\d{2}):(\d{2})/); return m?{sh:+m[1],sm:+m[2],eh:+m[3],em:+m[4]}:null; }
  function endOf(iso, r){ const p=parseRange(r); if(!p) return null; const d=new Date(iso); return new Date(d.getFullYear(), d.getMonth(), d.getDate(), p.eh, p.em); }
  function startOf(iso, r){ const p=parseRange(r); if(!p) return null; const d=new Date(iso); return new Date(d.getFullYear(), d.getMonth(), d.getDate(), p.sh, p.sm); }

  function dayOffset(k){const d=new Date(); d.setDate(d.getDate()+k); return toISO(d);}
  function u(level){ return {id:Math.random().toString(36).slice(2,7), name:'Hráč', avatar:"{{ url_for('static', filename='images/profile1.png') }}", level}; }

  const activeData = [
    {id:'p1', court:1, date:dayOffset(0), time:'18:00–19:00', quarters:{1:[u('M3')],2:[u('M2')],3:[u('M2')],4:[]} },
    {id:'p2', court:2, date:dayOffset(0), time:'19:00–20:00', quarters:{1:[],2:[u('M3')],3:[],4:[]} },
    {id:'p3', court:1, date:dayOffset(0), time:'08:00–09:00', quarters:{1:[u('M1')],2:[],3:[],4:[]} },
    {id:'p4', court:2, date:dayOffset(1), time:'10:00–11:00', quarters:{1:[],2:[],3:[u('M2')],4:[]} },
    {id:'p5', court:1, date:dayOffset(2), time:'17:00–18:00', quarters:{1:[],2:[],3:[],4:[u('M3')]} },
    {id:'p6', court:2, date:dayOffset(3), time:'16:00–17:00', quarters:{1:[u('M2')],2:[],3:[],4:[]} },
    {id:'p7', court:1, date:dayOffset(-1), time:'15:00–16:00', quarters:{1:[u('M2')],2:[u('M3')],3:[],4:[]} }
  ];

  const timeSlots = ['08:00–09:00','09:00–10:00','10:00–11:00','11:00–12:00','12:00–13:00','13:00–14:00','14:00–15:00','15:00–16:00','16:00–17:00','17:00–18:00','18:00–19:00','19:00–20:00'];
  const creator = { date: toISO(new Date()), court:1, time:null, quarter:1 };

  const minIso = toISO(new Date()); $("#cDate").min = minIso; $("#cDate").value = creator.date;

  function isSameDay(a,b){ return a===b; }
  function isPastSlot(iso, r){
    if(!isSameDay(iso, toISO(now))) return false;
    const e = endOf(iso,r); return e && e < now;
  }
  function isBookedByParties(court, iso, r){
    const m = activeData.find(p=>p.court===court && p.date===iso && p.time===r);
    if(!m) return {full:false, present:false};
    const count = [1,2,3,4].reduce((s,q)=> s + (m.quarters[q]?.length||0), 0);
    return {full: count>=4, present:true};
  }
  function pseudoDemoBlockedIndex(court, iso){
    const d=new Date(iso); const seed = court*13 + d.getDate()*7 + (d.getMonth()+1)*3;
    return seed % timeSlots.length;
  }

  $("#cDate").addEventListener('change', e => { creator.date=e.target.value; buildTimePills(); });
  $("#cCourts").addEventListener('click', e=>{
    const b=e.target.closest('.tab'); if(!b) return;
    $$("#cCourts .tab").forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); creator.court= +b.dataset.c; buildTimePills();
  });
  $("#cQuarters").addEventListener('click', e=>{
    const b=e.target.closest('.q-btn'); if(!b) return;
    $$("#cQuarters .q-btn").forEach(x=>x.classList.remove('sel'));
    b.classList.add('sel'); creator.quarter= +b.dataset.q;
  });

  function buildTimePills(){
    const wrap=$("#cTimes"); wrap.innerHTML='';
    creator.time=null;

    timeSlots.forEach((t, i)=>{
      let muted=false, title='';
      if(isPastSlot(creator.date, t)){ muted=true; title='Už prebehlo'; }
      const booked = isBookedByParties(creator.court, creator.date, t);
      if(booked.full){ muted=true; title='Obsadené (plné)'; }
      const demoIdx = pseudoDemoBlockedIndex(creator.court, creator.date);
      if(i===demoIdx && !booked.present){ muted=true; title='Obsadené'; }

      wrap.appendChild(el(
        `<button class="time-pill ${muted?'muted':''}" ${muted?'disabled':''} data-time="${t}" title="${title}">${t}</button>`
      ));
    });
  }
  buildTimePills();

  $("#cTimes").addEventListener('click', e=>{
    const p=e.target.closest('.time-pill'); if(!p || p.disabled) return;
    $$("#cTimes .time-pill").forEach(x=>x.classList.remove('sel'));
    p.classList.add('sel'); creator.time=p.dataset.time;
  });

  $("#cCreate").addEventListener('click', ()=>{
    if(!creator.time){ toast('Vyber čas'); return; }
    const clash = isBookedByParties(creator.court, creator.date, creator.time);
    if(clash.full){ toast('Tento čas je obsadený'); return; }

    const id='p'+Math.random().toString(36).slice(2,7);
    activeData.push({ id, court:creator.court, date:creator.date, time:creator.time, quarters:{1:[],2:[],3:[],4:[]} });
    const party = activeData[activeData.length-1];
    party.quarters[creator.quarter].push({...currentUser});
    toast('Partia vytvorená ✔︎');
    renderActive();
    buildTimePills();
  });

  /* ===== ACTIVE parties with filters & pagination (4 per row/page) ===== */
  let currentFilter = { type:'all', date:null }, curPage=1, perPage=4;

  $("#filterDate").addEventListener('change', e=>{
    currentFilter = {type:'date', date:e.target.value||null};
    highlightFilter();
    curPage=1; renderActive();
  });
  $$(".filters .f-pill").forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$(".filters .f-pill").forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t=btn.dataset.filter;
      if(t==='all') currentFilter={type:'all',date:null};
      else if(t==='today') currentFilter={type:'date',date:toISO(new Date())};
      else if(t==='tomorrow'){
        const d=new Date(); d.setDate(d.getDate()+1);
        currentFilter={type:'date',date:toISO(d)};
      }
      $("#filterDate").value = currentFilter.type==='date' ? currentFilter.date : '';
      curPage=1;
      renderActive();
    });
  });
  function highlightFilter(){
    $$(".filters .f-pill").forEach(b=>b.classList.remove('active'));
    if(currentFilter.type==='all') $(`[data-filter="all"]`).classList.add('active');
    else if(currentFilter.date===toISO(new Date())) $(`[data-filter="today"]`).classList.add('active');
    else {
      const tmr=new Date(); tmr.setDate(tmr.getDate()+1);
      if(currentFilter.date===toISO(tmr)) $(`[data-filter="tomorrow"]`).classList.add('active');
    }
  }

  function sortByDateTime(a,b){
    const sa=startOf(a.date,a.time), sb=startOf(b.date,b.time);
    return +sa - +sb;
  }
  function isPast(p){ const e=endOf(p.date,p.time); return e && e < new Date(); }
  function playersCount(p){ return [1,2,3,4].reduce((s,q)=>s+(p.quarters[q]?.length||0),0); }

  function filteredList(){
    let list = activeData.slice().sort(sortByDateTime);
    if(currentFilter.type==='date' && currentFilter.date) list=list.filter(p=>p.date===currentFilter.date);
    return list;
  }

  function statusInfo(p){
    const n = playersCount(p);
    if(n===1) return {cls:'chip-ok', text:'voľné miesta'};
    if(n===2) return {cls:'chip-warn', text:'chýbajú 2 hráči'};
    if(n===3) return {cls:'chip-bad', text:'chýba 1 hráč'};
    if(n>=4) return {cls:'', text:'plné'};
    return {cls:'chip-ok', text:'voľné miesta'};
  }

  function card(p, past){
    const full = playersCount(p)>=4;
    const st = statusInfo(p);
    const c = el(`
      <article class="party ${past?'muted-card':''}" data-id="${p.id}">
        <div class="party-head">
          <div style="min-width:0">
            <div class="p-title">Kurt ${p.court} • ${p.time}</div>
            <div class="p-meta">${nice(p.date)}</div>
          </div>
          <div class="p-cta">
            <span class="chip-state ${st.cls}"><span class="dot"></span>${st.text}</span>
            <span class="badge">${playersCount(p)}/4</span>
          </div>
        </div>
        <div class="court-wrap">
          <div class="court-img"></div>
          ${[1,2,3,4].map(q=>`<div class="q ${past?'past':''}" data-q="${q}"></div>`).join('')}
          <div class="slots">
            ${[1,2,3,4].map(q=>{
              const arr=p.quarters[q]||[];
              const avatars = arr.map((u,i)=>`<img class="pp" style="z-index:${20-i}" src="${u.avatar}" alt="${u.name}">`).join('');
              const lvl=arr[0]?.level || '';
              const plus = (!past && arr.length===0 && !full) ? `<button class="plus" data-join="${p.id}" data-quarter="${q}" aria-label="Pridať sa">+</button>` : '';
              return `
                <div class="slot">
                  <div class="pile">${avatars}</div>
                  ${lvl?`<div class="level">${lvl}</div>`:''}
                  ${plus}
                </div>`;
            }).join('')}
          </div>
          <div class="pop" role="dialog" aria-hidden="true">
            <div class="p-title">Pridať sa?</div>
            <div class="p-sub">${nice(p.date)} • ${p.time} • Kurt ${p.court}</div>
            <div class="row">
              <img src="${currentUser.avatar}" alt="${currentUser.name}">
              <div><b>${currentUser.name}</b><div style="color:#98a2b3">úroveň ${currentUser.level}</div></div>
            </div>
            <div class="act">
              <button class="btn btn-green btn-sm" data-confirm>Pridať sa</button>
              <button class="btn btn-sm" data-cancel>Zrušiť</button>
            </div>
          </div>
        </div>
      </article>
    `);
    return c;
  }

  function renderActive(){
    const strip=$("#activeStrip"); const pager=$("#pager");
    const list=filteredList();
    $("#activeCount").textContent = `${list.length} ${list.length===1?'hra':'hry'}`;

    const perPage=4;
    const pages = Math.max(1, Math.ceil(list.length/perPage));
    window.__curPage = Math.min(window.__curPage||1, pages);
    const start = (window.__curPage-1)*perPage, end = window.__curPage*perPage;
    const view = list.slice(start,end);

    strip.innerHTML='';
    view.forEach(p=> strip.appendChild(card(p, isPast(p))) );

    pager.innerHTML='';
    if(pages>1){
      pager.appendChild(el(`<button class="pgbtn" ${window.__curPage===1?'disabled':''} data-nav="prev">‹</button>`));
      for(let i=1;i<=pages;i++){
        pager.appendChild(el(`<button class="pgbtn ${i===window.__curPage?'active':''}" data-page="${i}">${i}</button>`));
      }
      pager.appendChild(el(`<button class="pgbtn" ${window.__curPage===pages?'disabled':''} data-nav="next">›</button>`));
    }
  }

  // initial render (defensive)
  renderActive();
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ()=>requestAnimationFrame(renderActive));
  } else {
    requestAnimationFrame(renderActive);
  }

  $("#pager").addEventListener('click', e=>{
    const b=e.target.closest('.pgbtn'); if(!b) return;
    const list=filteredList(); const pages=Math.max(1, Math.ceil(list.length/4));
    if(b.dataset.page){ window.__curPage=parseInt(b.dataset.page,10); renderActive(); }
    if(b.dataset.nav==='prev'){ window.__curPage=Math.max(1, (window.__curPage||1)-1); renderActive(); }
    if(b.dataset.nav==='next'){ window.__curPage=Math.min(pages, (window.__curPage||1)+1); renderActive(); }
  });

  let openPop = null, popCtx=null;
  $("#activeStrip").addEventListener('click', e=>{
    const plus = e.target.closest('.plus');
    if(plus){
      const card = plus.closest('.party');
      const pop  = card.querySelector('.pop');
      const wrap = card.querySelector('.court-wrap');
      const rPlus = plus.getBoundingClientRect();
      const rWrap = wrap.getBoundingClientRect();
      pop.style.left = (rPlus.left - rWrap.left + rPlus.width/2) + 'px';
      pop.style.top  = (rPlus.top  - rWrap.top - 10) + 'px';
      pop.classList.add('show');
      openPop = pop;
      popCtx  = { id: plus.dataset.join, q: +plus.dataset.quarter };
    }
    if(e.target.closest('[data-cancel]') && openPop){ openPop.classList.remove('show'); openPop=null; popCtx=null; }
    if(e.target.closest('[data-confirm]') && popCtx){
      const p = activeData.find(x=>x.id===popCtx.id);
      if(!p) return;
      const full = [1,2,3,4].reduce((s,q)=>s+(p.quarters[q]?.length||0),0) >= 4;
      if(full){ toast('Partia je plná'); openPop.classList.remove('show'); return; }
      if(!p.quarters[popCtx.q]) p.quarters[popCtx.q]=[];
      if(p.quarters[popCtx.q].length>0){
        const empty=[1,2,3,4].find(q=> (p.quarters[q]||[]).length===0 );
        if(empty) popCtx.q=empty;
      }
      p.quarters[popCtx.q].push({...currentUser});
      openPop.classList.remove('show'); openPop=null; popCtx=null;
      toast('Pridané do partie ✔︎');
      renderActive();
    }
  });
  document.addEventListener('click', e=>{
    if(openPop && !e.target.closest('.pop') && !e.target.closest('.plus')){
      openPop.classList.remove('show'); openPop=null; popCtx=null;
    }
  });

  /* filters rerender */
  $("#filterDate").addEventListener('change', ()=>{ window.__curPage=1; renderActive(); });
  $$(".filters .f-pill").forEach(b=> b.addEventListener('click', ()=>{ window.__curPage=1; }) );

})();
</script>
{% endblock %}
