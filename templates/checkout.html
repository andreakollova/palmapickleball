{% extends "base.html" %}
{% block title %}Checkout{% endblock %}

{% block content %}
<section class="container py-4">
  <div class="row g-4 g-lg-5">

    <!-- LEFT SIDE -->
    <div class="col-lg-7">
      <div class="card card-plain mb-4">
        <div class="card-body p-4">
          <h5 class="fw-semibold mb-3">Kontaktné údaje</h5>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">
                Meno <span class="text-danger">*</span>
              </label>
              <input type="text" class="form-control" id="c_first" placeholder="Meno" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">
                Priezvisko <span class="text-danger">*</span>
              </label>
              <input type="text" class="form-control" id="c_last" placeholder="Priezvisko" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Tel. číslo <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="c_phone" placeholder="+421 9XX XXX XXX" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Email <span class="text-danger">*</span></label>
              <input type="email" class="form-control" id="c_email" placeholder="email@domena.sk" required>
            </div>
          </div>
        </div>
      </div>

      <div class="card card-plain mb-4">
        <div class="card-body p-4">
          <h5 class="fw-semibold mb-3">Fakturačné údaje</h5>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="companyCheck">
            <label class="form-check-label fw-medium" for="companyCheck">Fakturovať na firmu</label>
          </div>

          <div id="companyFields" class="row g-3 d-none">
            <div class="col-md-12">
              <label class="form-label">Názov firmy <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="b_company" placeholder="Názov firmy">
            </div>
            <div class="col-md-4">
              <label class="form-label">IČO <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="b_ico" placeholder="IČO">
            </div>
            <div class="col-md-4">
              <label class="form-label">DIČ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="b_dic" placeholder="DIČ">
            </div>
            <div class="col-md-4">
              <label class="form-label">IČ DPH</label>
              <input type="text" class="form-control" id="b_icdph" placeholder="IČ DPH">
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-6">
              <label class="form-label">Adresa <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="b_address" placeholder="Adresa" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Mesto <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="b_city" placeholder="Mesto" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">PSČ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="b_zip" placeholder="PSČ" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Krajina</label>
              <select class="form-select" id="b_country">
                <option selected>Vyberte krajinu</option>
                <option>Slovensko</option>
                <option>Česko</option>
                <option>Poľsko</option>
                <option>Maďarsko</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="card card-plain mb-4">
        <div class="card-body p-4">
          <h5 class="fw-semibold mb-3">Platba kartou</h5>
          <form id="payment-form">
            <div id="payment-element" class="mb-2"></div>

            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="termsCheck" required>
              <label class="form-check-label small" for="termsCheck">
                Súhlasím s <a href="#" class="link-accent">obchodnými podmienkami</a> a
                <a href="#" class="link-accent">ochranou osobných údajov</a>
                <span class="text-danger">*</span>
              </label>
            </div>
          </form>
          <div id="leftError" class="text-danger small mt-2"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT SIDE -->
    <div class="col-lg-5">
      <aside class="order card card-plain sticky-lg-top" style="top:88px;">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-semibold mb-0">Nákupný košík</h5>
          </div>

          <!-- Court + date/time -->
          <div class="p-3 rounded-3 border bg-light mb-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="fw-semibold">Rezervácia kurtu</div>
                <div class="small text-muted">
                  Palma Pickleball Bratislava (Kurt {{ court }})<br>
                  {{ date }}{% if time_str %} • {{ time_str }}{% endif %}
                </div>
              </div>
              <div class="fw-semibold ms-3" id="summaryTotal">{{ total or "20,00 €" }}</div>
            </div>

            <!-- Add-ons block (filled by JS) -->
            <div id="addonsBlock" class="mt-3"></div>
          </div>

          <div class="d-flex justify-content-between small mb-2">
            <span>Spolu bez DPH</span><span id="sum_net">—</span>
          </div>
          <div class="d-flex justify-content-between small mb-3">
            <span>DPH (23 %)</span><span id="sum_vat">—</span>
          </div>
          <div class="d-flex justify-content-between fw-semibold border-top pt-3 mb-3">
            <span>Spolu</span><span id="sum_gross">{{ total or "20,00 €" }}</span>
          </div>

          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="haveCoupon">
            <label class="form-check-label" for="haveCoupon">Mám zľavový kód</label>
          </div>

          <div id="couponWrap" class="d-none">
            <label class="form-label fw-medium">Zľavový kód</label>
            <div class="input-group mb-2">
              <input type="text" class="form-control" id="coupon" placeholder="Zadajte kód">
              <button class="btn btn-outline-primary" type="button" id="applyCoupon">Uplatniť</button>
            </div>
            <div id="couponMsg" class="small"></div>
          </div>

          <!-- ===== HOLD BANNER (timer) ===== -->
          <div id="holdTimer" class="alert alert-warning py-2 small mb-2" aria-live="polite" style="display:none;"></div>

          <button id="payBtn" class="btn btn-primary w-100 py-2">Zaplatiť</button>
          <div id="summaryError" class="text-danger small mt-2"></div>

          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="saveCard" checked>
            <label class="form-check-label small" for="saveCard">
              Zapamätať kartu pre rýchlejšie budúce rezervácie.
            </label>
          </div>

          <button class="btn btn-outline-secondary w-100 mt-2">Pokračovať v nákupe</button>
        </div>
      </aside>
    </div>

  </div>
</section>

<script src="https://js.stripe.com/v3/"></script>
<script>
  // Company toggle
  document.getElementById("companyCheck").addEventListener("change", (e)=>{
    document.getElementById("companyFields").classList.toggle("d-none", !e.target.checked);
  });

  // Coupon toggle
  const haveCoupon = document.getElementById("haveCoupon");
  const couponWrap = document.getElementById("couponWrap");
  haveCoupon.addEventListener("change", ()=>couponWrap.classList.toggle("d-none", !haveCoupon.checked));

  const VAT_RATE = 0.23;
  function parseToCents(text){
    let s=String(text||"").trim().replace(/[^\d,.\-]/g,"");
    if(s.includes(",")&&s.includes("."))s=s.replace(/,/g,""); else s=s.replace(",",".");
    const v=parseFloat(s); return isNaN(v)?0:Math.round(v*100);
  }
  function formatCents(c){return(c/100).toLocaleString("sk-SK",{style:"currency",currency:"EUR"});}
  function computeVatFromGross(g,v){const n=Math.round(g/(1+v));const vat=g-n;return{net:n,vat:vat,gross:g};}
  function refreshVat(){
    const g=parseToCents(document.getElementById("summaryTotal").textContent);
    const {net,vat,gross}=computeVatFromGross(g,VAT_RATE);
    document.getElementById("sum_net").textContent=formatCents(net);
    document.getElementById("sum_vat").textContent=formatCents(vat);
    document.getElementById("sum_gross").textContent=formatCents(gross);
  }

  // ===================== ADD-ONS =====================
  // prices in cents
  const ADDON_PRICES = { racket: 300, camera: 1000 }; // 3€ / 10€
  const IMG_RACKET = "{{ url_for('static', filename='images/shop/rakety.png') }}";
  const IMG_CAMERA = "{{ url_for('static', filename='images/shop/kamera.png') }}";

  // capture the base price at page load (court only)
  const BASE_GROSS_CENTS = parseToCents(document.getElementById("sum_gross").textContent || document.getElementById("summaryTotal").textContent);

  // simple state
  let qtyRackets = 0;
  let qtyCamera  = 0;

  // keep track if a coupon was applied so we can re-apply after qty changes
  let couponCodeApplied = null;

  function euros(c){ return (c/100).toLocaleString('sk-SK', { style:'currency', currency:'EUR' }); }

  function addonCents(){
    return qtyRackets * ADDON_PRICES.racket + qtyCamera * ADDON_PRICES.camera;
  }

  function reapplyCouponIfAny(grossCents){
    if(!couponCodeApplied) return grossCents;
    const c = COUPONS[couponCodeApplied];
    if(!c) return grossCents;
    if(c.type === "percent") return Math.max(0, Math.round(grossCents * (1 - c.value/100)));
    return Math.max(0, grossCents - Math.round(c.value*100));
  }

  function recalcTotals(){
    // base + add-ons
    let gross = BASE_GROSS_CENTS + addonCents();
    // re-apply coupon if user has one active
    gross = reapplyCouponIfAny(gross);

    // write back to UI
    document.getElementById("summaryTotal").textContent = euros(gross);
    document.getElementById("sum_gross").textContent   = euros(gross);
    refreshVat();

    // re-create Stripe intent for new amount
    reinitElements();
    // also refresh add-ons summary list
    renderAddonsSummary();
  }

  function renderAddonsUI(){
    const wrap = document.getElementById('addonsBlock');
    if(!wrap) return;
    wrap.innerHTML = `
      <div class="border-top pt-3">
        <div class="fw-semibold mb-2">Doplnkové služby</div>

        <!-- Rackets -->
        <div class="d-flex align-items-center justify-content-between py-2">
          <div class="d-flex align-items-center gap-2">
            <img src="${IMG_RACKET}" alt="Rakety" style="width:34px;height:34px;object-fit:contain">
            <div>
              <div>Požičanie rakety</div>
              <div class="small text-muted">3,00&nbsp;€ / ks</div>
            </div>
          </div>

          <div class="d-inline-flex align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="decR">−</button>
            <span id="qtyR" class="minw-2 text-center" style="display:inline-block;width:24px">${qtyRackets}</span>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="incR">+</button>
          </div>
        </div>

        <!-- Camera -->
        <div class="d-flex align-items-center justify-content-between py-2 border-top">
          <div class="d-flex align-items-center gap-2">
            <img src="${IMG_CAMERA}" alt="Požičanie kamery POV Pro" style="width:34px;height:34px;object-fit:contain">
            <div>
              <div>Požičanie kamery POV Pro</div>
              <div class="small text muted">10,00&nbsp;€ / ks</div>
            </div>
          </div>

          <div class="d-inline-flex align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="decC">−</button>
            <span id="qtyC" class="minw-2 text-center" style="display:inline-block;width:24px">${qtyCamera}</span>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="incC">+</button>
          </div>
        </div>
      </div>
    `;

    // wire up buttons
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    document.getElementById('incR').onclick = ()=>{ qtyRackets = clamp(qtyRackets+1,0,20); document.getElementById('qtyR').textContent = qtyRackets; recalcTotals(); };
    document.getElementById('decR').onclick = ()=>{ qtyRackets = clamp(qtyRackets-1,0,20); document.getElementById('qtyR').textContent = qtyRackets; recalcTotals(); };
    document.getElementById('incC').onclick = ()=>{ qtyCamera  = clamp(qtyCamera +1,0,20); document.getElementById('qtyC').textContent = qtyCamera;  recalcTotals(); };
    document.getElementById('decC').onclick = ()=>{ qtyCamera  = clamp(qtyCamera -1,0,20); document.getElementById('qtyC').textContent = qtyCamera;  recalcTotals(); };
  }

  // small summary (lines) under court block
  function renderAddonsSummary(){
    // intentionally left simple
  }

  // ===================== COUPON LOGIC (unchanged, with memory) =====================
  const COUPONS={
    "PALMA10":{type:"percent",value:10},
    "PALMA5":{type:"amount",value:5}
  };
  const couponMsg=document.getElementById("couponMsg");
  document.getElementById("applyCoupon").addEventListener("click",async()=>{
    const code=document.getElementById("coupon").value.trim().toUpperCase();
    const c=COUPONS[code];
    if(!c){couponMsg.textContent="Zľavový kód nie je uplatnený.";couponMsg.className="small text-danger";couponCodeApplied=null;return;}
    couponCodeApplied = code; // remember active coupon
    recalcTotals(); // re-run totals with coupon
    couponMsg.textContent="Zľava uplatnená.";couponMsg.className="small text-success";
  });

  // ===================== STRIPE =====================
  const stripe=Stripe("{{ stripe_key }}");
  const payBtn=document.getElementById("payBtn");
  const errRight=document.getElementById("summaryError");
  const errLeft=document.getElementById("leftError");
  let elements,clientSecret,mountedEl;

  function totalText(){return(document.getElementById("sum_gross").textContent||"20,00 €").trim();}
  function getQty(id){ const el=document.getElementById(id); return el?parseInt(el.textContent||"0",10):0; }
  function bodyForIntent(){return{
    amount:totalText(),
    currency:"eur",
    date:{{(date or "")|tojson}},
    court:{{(court or "")|tojson}},
    time: {{ (time_str or "") | tojson }},
    rackets: getQty("qtyR"),
    cameras: getQty("qtyC")
  };}

  async function createIntent(){
    const r=await fetch("/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(bodyForIntent())});
    const d=await r.json();if(!r.ok||!d.clientSecret)throw new Error("Nepodarilo sa pripraviť platbu.");return d.clientSecret;
  }

  async function initElements(){
    try{
      payBtn.disabled=true;payBtn.textContent="Pripravujem…";
      clientSecret=await createIntent();
      elements=stripe.elements({clientSecret,appearance:{theme:"stripe",variables:{colorPrimary:"#3a38d6"}}});
      mountedEl=elements.create("payment",{layout:"tabs"});
      mountedEl.mount("#payment-element");
      payBtn.disabled=false;payBtn.textContent="Zaplatiť";
    }catch(e){errRight.textContent=e.message;}
  }

  async function reinitElements(){
    try{
      payBtn.disabled=true;
      if(mountedEl){mountedEl.unmount();mountedEl=null;}
      await initElements();
    }finally{payBtn.disabled=false;}
  }

  // init page
  renderAddonsUI();
  refreshVat();
  initElements();

  /* ====== HOLD TIMER: spusti odpočítavanie po inicializácii ====== */
  (function setupHoldTimer(){
    const el = document.getElementById('holdTimer');
    if (!el) return;

    // zdroje: ?hold_expires= / sessionStorage('hold_expires' | 'holdDeadline')
    const qs = new URLSearchParams(location.search);
    let raw = qs.get('hold_expires')
             || sessionStorage.getItem('hold_expires')
             || sessionStorage.getItem('holdDeadline');

    if (!raw) { el.style.display='none'; return; }

    // podpor ISO aj epoch (ms)
    let deadline = NaN;
    if (/^\d{10,}$/.test(raw)) {         // číslo (sekundy/ms)
      const n = Number(raw);
      deadline = (n < 1e12) ? n*1000 : n;
    } else {
      deadline = Date.parse(raw);
    }
    if (isNaN(deadline)) { el.style.display='none'; return; }

    el.style.display='block';

    function update(){
      const sec = Math.max(0, Math.floor((deadline - Date.now())/1000));
      const mm = String(Math.floor(sec/60)).padStart(2,'0');
      const ss = String(sec%60).padStart(2,'0');

      if (sec > 0) {
        el.textContent = `Sloty držíme ešte ${mm}:${ss}`;
      } else {
        el.classList.remove('alert-warning');
        el.classList.add('alert-danger');
        el.textContent = 'Čas na zaplatenie vypršal. Vyberte prosím termín znova.';
        payBtn.disabled = true;
        try { if (mountedEl) { mountedEl.unmount(); mountedEl = null; } } catch {}
        clearInterval(tid);
      }
    }
    update();
    const tid = setInterval(update, 1000);
  })();

  /* ===== helper: zrekonštruuj sloty z rozsahu "HH:MM – HH:MM" ===== */
  function buildSlotsFromRange(rangeStr){
    const m = String(rangeStr || "").match(/(\d{2}:\d{2}).*?(\d{2}:\d{2})/);
    if (!m) return [];
    const start = m[1], end = m[2];
    const toMin = s => parseInt(s.slice(0,2),10)*60 + parseInt(s.slice(3,5),10);
    const toStr = mm => `${String(Math.floor(mm/60)).padStart(2,'0')}:${String(mm%60).padStart(2,'0')}`;
    const out = [];
    for (let t = toMin(start); t < toMin(end); t += 30) out.push(toStr(t));
    return out;
  }

  // ===== CONTINUE SHOPPING: release server hold + clear local + go back =====
  (function wireBackToShop(){
    const backBtn = document.querySelector('.order .btn.btn-outline-secondary.w-100.mt-2');
    if (!backBtn) return;

    backBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      backBtn.disabled = true;

      const payload = {
        date: {{ (date or "") | tojson }},
        court: {{ (court or "") | tojson }},
        slots: buildSlotsFromRange({{ (time_str or "") | tojson }})
      };

      try {
        if (payload.date && payload.court && payload.slots && payload.slots.length){
          await fetch("/api/release", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            credentials: "same-origin"
          });
        }
      } catch(_) {}

      try { sessionStorage.removeItem('hold_expires'); } catch {}
      try { sessionStorage.removeItem('holdDeadline'); } catch {}

      window.location.href = "{{ url_for('index') }}#rezervacia";
    });
  })();

  // Pay
  // Pay
  payBtn.addEventListener("click", async () => {
    if (payBtn.disabled) return;

    errRight.textContent = "";
    errLeft.textContent  = "";

    if (!document.getElementById("termsCheck").checked) {
      errRight.textContent = "Musíte súhlasiť s podmienkami.";
      return;
    }

    payBtn.disabled = true;
    payBtn.textContent = "Spracúvam…";

    // Build success URL (so zobrazíš sumár)
    const successBase = "{{ url_for('rezervacia_uspesna', _external=True) }}";
    const successUrl =
      successBase
      + "?date="  + encodeURIComponent({{ (date or "")    | tojson }})
      + "&time="  + encodeURIComponent({{ (time_str or "")| tojson }})
      + "&court=" + encodeURIComponent("Kurt " + {{ (court or "") | tojson }})
      + "&total=" + encodeURIComponent(totalText());

    try {
      // ✅ REQUIRED for Link / autofill / deferred flow
      const { error: submitError } = await elements.submit();
      if (submitError) {
        errRight.textContent = submitError.message || "Chyba pri odoslaní platobných údajov.";
        payBtn.disabled = false;
        payBtn.textContent = "Zaplatiť";
        return;
      }

      const { error, paymentIntent } = await stripe.confirmPayment({
        elements,
        clientSecret,
        redirect: 'if_required',              // 3DS → Stripe urobí redirect na return_url
        confirmParams: { return_url: successUrl }
      });

      if (error) {
        errRight.textContent = error.message || "Platbu sa nepodarilo potvrdiť.";
        payBtn.disabled = false;
        payBtn.textContent = "Zaplatiť";
        return;
      }

      // Bez 3DS: rovno presmeruj na úspech
      if (paymentIntent &&
          (paymentIntent.status === 'succeeded' ||
           paymentIntent.status === 'processing' ||
           paymentIntent.status === 'requires_capture')) {
        window.location.href = successUrl + "&pi=" + encodeURIComponent(paymentIntent.id);
        return;
      }

      // Fallback
      payBtn.disabled = false;
      payBtn.textContent = "Zaplatiť";
    } catch (e) {
      errRight.textContent = e.message || "Neznáma chyba.";
      payBtn.disabled = false;
      payBtn.textContent = "Zaplatiť";
    }
  });
</script>

<style>
  :root{
    --accent:#3a38d6;
    --border-soft:#e6e9ef;
  }

  .btn-primary{background:var(--accent);border-color:var(--accent);}
  .btn-primary:hover{background:var(--accent);filter:brightness(.95);}
  .btn-outline-primary{color:var(--accent);border-color:var(--accent);}
  .btn-outline-primary:hover{background:var(--accent);border-color:var(--accent);}
  .form-check-input:checked{background-color:var(--accent);border-color:var(--accent);}
  .link-accent{color:var(--accent);}
  .card-plain{border:1px solid var(--border-soft)!important;border-radius:12px;box-shadow:none!important;}
  .order .card-body{background:#fafbfd;}

  .form-label{font-size:.95rem;font-weight:500;color:#111827;margin-bottom:.35rem;}
  .form-control::placeholder,.form-select::placeholder{color:#9aa3af;opacity:1;font-size:.95rem;}
  .form-control,.form-select{padding:.56rem .75rem;border-color:#e5e7eb;}

  #payment-element{padding-top:.25rem;}
  #couponMsg{min-height:1.25rem;}

  @media(max-width:991.98px){
    .order{position:static!important;top:auto!important;}
  }

  label[for="haveCoupon"] {
    font-size: 0.9rem;
    position: relative;
    top: -2px;
  }

  #sum_gross {
    font-size: 1.2rem;
    font-weight: 600;
  }
  .d-flex.justify-content-between.fw-semibold.border-top.pt-3.mb-3 span:first-child {
    font-size: 1.05rem;
  }

  @media (min-width: 992px) {
    :root { --header-h: 112px; }
    .order.sticky-lg-top { top: var(--header-h); z-index: 1; }
  }
</style>
{% endblock %}
