{% extends "base.html" %}
{% block title %}Checkout{% endblock %}

{% block content %}
<section class="container py-5">
  <div class="row g-4 g-lg-5">

    <!-- LEFT SIDE -->
    <div class="col-lg-7">
      <div class="card card-plain mb-4">
        <div class="card-body p-4">
          <h5 class="fw-semibold mb-3">Kontaktné údaje</h5>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">
                Meno <span class="text-danger">*</span>
              </label>
              <input type="text" class="form-control" id="c_first" placeholder="Meno" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">
                Priezvisko <span class="text-danger">*</span>
              </label>
              <input type="text" class="form-control" id="c_last" placeholder="Priezvisko" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Tel. číslo <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="c_phone" placeholder="+421 9XX XXX XXX" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Email <span class="text-danger">*</span></label>
              <input type="email" class="form-control" id="c_email" placeholder="email@domena.sk" required>
            </div>
          </div>
        </div>
      </div>

      <div class="card card-plain mb-4">
        <div class="card-body p-4">
          <h5 class="fw-semibold mb-3">Fakturačné údaje</h5>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="companyCheck">
            <label class="form-check-label fw-medium" for="companyCheck">Fakturovať na firmu</label>
          </div>

          <div id="companyFields" class="row g-3 d-none">
            <div class="col-md-12">
              <label class="form-label">Názov firmy <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="b_company" placeholder="Názov firmy">
            </div>
            <div class="col-md-4">
              <label class="form-label">IČO <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="b_ico" placeholder="IČO">
            </div>
            <div class="col-md-4">
              <label class="form-label">DIČ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="b_dic" placeholder="DIČ">
            </div>
            <div class="col-md-4">
              <label class="form-label">IČ DPH</label>
              <input type="text" class="form-control" id="b_icdph" placeholder="IČ DPH">
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-6">
              <label class="form-label">Adresa <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="b_address" placeholder="Adresa" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Mesto <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="b_city" placeholder="Mesto" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">PSČ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="b_zip" placeholder="PSČ" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Krajina</label>
              <select class="form-select" id="b_country">
                <option selected>Vyberte krajinu</option>
                <option>Slovensko</option>
                <option>Česko</option>
                <option>Poľsko</option>
                <option>Maďarsko</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="card card-plain mb-4">
        <div class="card-body p-4">
          <h5 class="fw-semibold mb-3">Platba kartou</h5>
          <form id="payment-form">
            <div id="payment-element" class="mb-2"></div>

            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="termsCheck" required>
              <label class="form-check-label small" for="termsCheck">
                Súhlasím s <a href="#" class="link-accent">obchodnými podmienkami</a> a
                <a href="#" class="link-accent">ochranou osobných údajov</a>
                <span class="text-danger">*</span>
              </label>
            </div>
          </form>
          <div id="leftError" class="text-danger small mt-2"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT SIDE -->
    <div class="col-lg-5">
      <aside class="order card card-plain sticky-lg-top" style="top:88px;">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-semibold mb-0">Nákupný košík</h5>
            <span class="text-muted small">{{ now.strftime("%H:%M") if now else "" }}</span>
          </div>

          <div class="p-3 rounded-3 border bg-light mb-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="fw-semibold">Rezervácia kurtu</div>
                <div class="small text-muted">
                  Palma Pickleball Bratislava (Kurt {{ court }})<br>
                  {{ date }}{% if time or request.args.get('time') %} • {{ time if time else request.args.get('time') }}{% endif %}
                </div>
              </div>
              <div class="fw-semibold ms-3" id="summaryTotal">{{ total or "20,00 €" }}</div>
            </div>
          </div>

          <div class="d-flex justify-content-between small mb-2">
            <span>Spolu bez DPH</span><span id="sum_net">—</span>
          </div>
          <div class="d-flex justify-content-between small mb-3">
            <span>DPH (23 %)</span><span id="sum_vat">—</span>
          </div>
          <div class="d-flex justify-content-between fw-semibold border-top pt-3 mb-3">
            <span>Spolu</span><span id="sum_gross">{{ total or "20,00 €" }}</span>
          </div>

          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="haveCoupon">
            <label class="form-check-label" for="haveCoupon">Mám zľavový kód</label>
          </div>

          <div id="couponWrap" class="d-none">
            <label class="form-label fw-medium">Zľavový kód</label>
            <div class="input-group mb-2">
              <input type="text" class="form-control" id="coupon" placeholder="Zadajte kód">
              <button class="btn btn-outline-primary" type="button" id="applyCoupon">Uplatniť</button>
            </div>
            <div id="couponMsg" class="small"></div>
          </div>

          <button id="payBtn" class="btn btn-primary w-100 py-2">Zaplatiť</button>
          <div id="summaryError" class="text-danger small mt-2"></div>

          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="saveCard" checked>
            <label class="form-check-label small" for="saveCard">
              Zapamätať kartu (automatické predĺženie členstva je možné kedykoľvek zrušiť).
            </label>
          </div>

          <button class="btn btn-outline-secondary w-100 mt-2">Pokračovať v nákupe</button>
        </div>
      </aside>
    </div>

  </div>
</section>

<script src="https://js.stripe.com/v3/"></script>
<script>
  // Company toggle
  document.getElementById("companyCheck").addEventListener("change", (e)=>{
    document.getElementById("companyFields").classList.toggle("d-none", !e.target.checked);
  });

  // Coupon toggle
  const haveCoupon = document.getElementById("haveCoupon");
  const couponWrap = document.getElementById("couponWrap");
  haveCoupon.addEventListener("change", ()=>couponWrap.classList.toggle("d-none", !haveCoupon.checked));

  const VAT_RATE = 0.23;
  function parseToCents(text){
    let s=String(text||"").trim().replace(/[^\d,.\-]/g,"");
    if(s.includes(",")&&s.includes("."))s=s.replace(/,/g,""); else s=s.replace(",",".");
    const v=parseFloat(s); return isNaN(v)?0:Math.round(v*100);
  }
  function formatCents(c){return(c/100).toLocaleString("sk-SK",{style:"currency",currency:"EUR"});}
  function computeVatFromGross(g,v){const n=Math.round(g/(1+v));const vat=g-n;return{net:n,vat:vat,gross:g};}
  function refreshVat(){
    const g=parseToCents(document.getElementById("summaryTotal").textContent);
    const {net,vat,gross}=computeVatFromGross(g,VAT_RATE);
    document.getElementById("sum_net").textContent=formatCents(net);
    document.getElementById("sum_vat").textContent=formatCents(vat);
    document.getElementById("sum_gross").textContent=formatCents(gross);
  }
  refreshVat();

  // Coupon logic
  const COUPONS={
    "PALMA10":{type:"percent",value:10},
    "PALMA5":{type:"amount",value:5}
  };
  const couponMsg=document.getElementById("couponMsg");
  document.getElementById("applyCoupon").addEventListener("click",async()=>{
    const code=document.getElementById("coupon").value.trim().toUpperCase();
    const gross=parseToCents(document.getElementById("summaryTotal").textContent);
    const c=COUPONS[code];
    if(!c){couponMsg.textContent="Zľavový kód nie je uplatnený.";couponMsg.className="small text-danger";return;}
    let newC=gross;
    if(c.type==="percent")newC=Math.max(0,Math.round(gross*(1-c.value/100)));
    else newC=Math.max(0,gross-Math.round(c.value*100));
    document.getElementById("summaryTotal").textContent=formatCents(newC);
    refreshVat();
    couponMsg.textContent="Zľava uplatnená.";couponMsg.className="small text-success";
    await reinitElements();
  });

  // Stripe
  const stripe=Stripe("{{ stripe_key }}");
  const payBtn=document.getElementById("payBtn");
  const errRight=document.getElementById("summaryError");
  const errLeft=document.getElementById("leftError");
  let elements,clientSecret,mountedEl;

  function totalText(){return(document.getElementById("sum_gross").textContent||"20,00 €").trim();}
  function bodyForIntent(){return{
    amount:totalText(),
    currency:"eur",
    date:{{(date or "")|tojson}},
    court:{{(court or "")|tojson}},
    time:{{(time or request.args.get('time') or "")|tojson}}
  };}

  async function createIntent(){
    const r=await fetch("/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(bodyForIntent())});
    const d=await r.json();if(!r.ok||!d.clientSecret)throw new Error("Nepodarilo sa pripraviť platbu.");return d.clientSecret;
  }

  async function initElements(){
    try{
      payBtn.disabled=true;payBtn.textContent="Pripravujem…";
      clientSecret=await createIntent();
      elements=stripe.elements({clientSecret,appearance:{theme:"stripe",variables:{colorPrimary:"#3a38d6"}}});
      mountedEl=elements.create("payment",{layout:"tabs"});
      mountedEl.mount("#payment-element");
      payBtn.disabled=false;payBtn.textContent="Zaplatiť";
    }catch(e){errRight.textContent=e.message;}
  }

  async function reinitElements(){
    try{
      payBtn.disabled=true;
      if(mountedEl){mountedEl.unmount();mountedEl=null;}
      await initElements();
    }finally{payBtn.disabled=false;}
  }
  initElements();

  payBtn.addEventListener("click",async()=>{
    errRight.textContent="";errLeft.textContent="";
    if(!document.getElementById("termsCheck").checked){errRight.textContent="Musíte súhlasiť s podmienkami.";return;}
    payBtn.disabled=true;payBtn.textContent="Spracúvam…";
    const {error}=await stripe.confirmPayment({elements,clientSecret,confirmParams:{return_url:window.location.origin+"/payment-success"}});
    if(error){errRight.textContent=error.message;payBtn.disabled=false;payBtn.textContent="Zaplatiť";}
  });
</script>

<style>
  :root{
    --accent:#3a38d6;
    --border-soft:#e6e9ef;
  }

  .btn-primary{background:var(--accent);border-color:var(--accent);}
  .btn-primary:hover{background:var(--accent);filter:brightness(.95);}
  .btn-outline-primary{color:var(--accent);border-color:var(--accent);}
  .btn-outline-primary:hover{background:var(--accent);border-color:var(--accent);}
  .form-check-input:checked{background-color:var(--accent);border-color:var(--accent);}
  .link-accent{color:var(--accent);}
  .card-plain{border:1px solid var(--border-soft)!important;border-radius:12px;box-shadow:none!important;}
  .order .card-body{background:#fafbfd;}

  /* ==== Stripe-like label & placeholder tweaks (only this changed) ==== */
  .form-label{
    font-size: .95rem;       /* a bit smaller, like Stripe */
    font-weight: 500;        /* medium, slightly lighter feel */
    color: #111827;
    margin-bottom: .35rem;   /* tighter spacing like Stripe */
  }
  .form-control::placeholder,
  .form-select::placeholder{
    color:#9aa3af;           /* lighter placeholder */
    opacity:1;
    font-size:.95rem;        /* slightly smaller placeholder text */
  }
  /* Inputs look closer to Stripe when padding is comfy and border subtle */
  .form-control, .form-select{
    padding:.56rem .75rem;
    border-color:#e5e7eb;
  }

  #payment-element{padding-top:.25rem;}
  #couponMsg{min-height:1.25rem;}

  @media(max-width:991.98px){
    .order{position:static!important;top:auto!important;}
  }
</style>
{% endblock %}
