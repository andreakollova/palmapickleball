{# templates/partials/reservation_modal.html #}

<!-- ================= Rezervácia (modern final, aligned) ================= -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-slim">
    <div class="modal-content rezv">

      <!-- Header -->
      <div class="rezv__hdr">
        <h5 class="rezv__title">Rezervácia</h5>
        <button type="button" class="btn-close rezv__close" data-bs-dismiss="modal" aria-label="Zavrieť"></button>
      </div>

      <!-- Body -->
      <div class="rezv__body">
        <div class="rezv__grid">
          <!-- LEFT: summary -->
          <section class="rezv__left">
            <h6 class="rezv__sec">Sumár</h6>

            <ul class="rezv__list">
              <li class="rezv__row">
                <div class="rezv__label">Kurt</div>
                <div class="rezv__val" id="mCourt">—</div>
              </li>

              <li class="rezv__row">
                <div class="rezv__label">Dátum</div>
                <div class="rezv__val" id="mDate">—</div>
              </li>

              <li class="rezv__row">
                <div class="rezv__label">Čas</div>
                <div class="rezv__val" id="mTime">—</div>
              </li>

              <li class="rezv__row rezv__row--place">
                <div class="rezv__label">Miesto</div>
                <div class="rezv__val rezv__val--place">
                  <!-- Desktop line (name + logo); “ Courts” added via CSS on desktop -->
                  <div class="rezv__placeLine">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Palma Pickleball" class="rezv__logo">
                    <span class="rezv__placeName">Palma Pickleball</span>
                  </div>

                  <!-- Address block (mobile-friendly) -->
                  <div class="rezv__addr">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="" class="addr-logo" aria-hidden="true">
                    <span class="addr-name">Palma Pickleball</span><br>
                    <span class="addr-street">Račianska 12,</span>
                    <span class="addr-zip">831 02, Bratislava</span>
                  </div>
                </div>
              </li>

              <!-- Total row -->
              <li class="rezv__row rezv__row--total rezv__align-left">
                <div class="rezv__label">Suma rezervácie</div>
                <div class="rezv__val rezv__val--accent">
                  <i class="bi bi-cash-coin me-1" aria-hidden="true"></i>
                  <span id="mTotal">—</span>
                </div>
              </li>
            </ul>

            <!-- Note -->
            <div class="rezv__noteArea">
              <label for="mNote" class="rezv__noteLbl">Poznámka (voliteľné)</label>
              <textarea id="mNote" class="form-control rezv__note rezv__align-left" rows="1" placeholder="Poznámka k rezervácii..."></textarea>
            </div>
          </section>

          <!-- RIGHT: image -->
          <section class="rezv__right">
            <div class="rezv__media">
              <div class="rezv__badge" id="mCourtBadge">Kurt</div>
              <img id="mImg" class="rezv__photo" src="{{ url_for('static', filename='images/us1.png') }}" alt="Kurt">
            </div>
          </section>
        </div>
      </div>

      <!-- Footer -->
      <div class="rezv__ftr">
        <button class="btn btn-light border d-inline-flex align-items-center gap-2" data-bs-dismiss="modal">
          <span class="lbl-dt">Zrušiť rezerváciu</span>
          <span class="lbl-mob">Zrušiť</span>
        </button>
        <button id="modalConfirmBtn" type="button" class="btn btn-accent d-inline-flex align-items-center gap-2">
          <i class="fa-solid fa-cart-shopping"></i>
          <span class="lbl-dt">Prejsť do pokladne</span>
          <span class="lbl-mob">Do pokladne</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ================= Styles (scoped to this modal) ================= -->
<style>
/* Accent + buttons */
#confirmModal .text-accent{color:#3a38d6;}
#confirmModal .btn-accent{background:#3a38d6;border-color:#3a38d6;color:#fff;}
#confirmModal .btn-accent:hover{background:#312fd1;border-color:#312fd1;color:#fff;}

/* Dialog width, spacing & rounding */
#confirmModal .modal-slim{
  max-width: 880px;
  margin: 1.75rem auto;
  padding: 0 1rem;
}
@media (max-width: 991.98px){ #confirmModal .modal-slim{max-width: 96vw; margin: 1rem auto;} }

#confirmModal .rezv{
  border:1px solid #e9ecf3; border-radius:5px;
  overflow:hidden; display:flex; flex-direction:column;
  max-height:92dvh; background:#fff; padding:8px 12px 12px;
}

/* Header */
#confirmModal .rezv__hdr{position:relative; padding:20px 22px; border-bottom:1px solid #eef1f6; text-align:center;}
#confirmModal .rezv__title{margin:0; font-size:1.08rem; font-weight:600; color:#0f172a; letter-spacing:0.01em;}
#confirmModal .rezv__close{position:absolute; right:16px; top:16px;}

/* Body + grid */
#confirmModal .rezv__body{padding:18px 20px; overflow:auto;}
#confirmModal .rezv__grid{display:grid; gap:20px; grid-template-columns: 1.05fr 1fr; align-items:stretch;}
@media (max-width: 991.98px){ #confirmModal .rezv__grid{grid-template-columns:1fr;} }

/* Left column */
#confirmModal .rezv__left{display:flex; flex-direction:column; min-height:100%;}
#confirmModal .rezv__sec{margin:0px 0 4px; font-size:1.1rem; font-weight:650; color:#0f172a;}

/* Rows */
#confirmModal .rezv__list{list-style:none; margin:0 0 12px; padding:0; flex:0 0 auto;}
#confirmModal .rezv__row{
  --label-w: 160px;
  display:grid; grid-template-columns: var(--label-w) 1fr; align-items:center;
  gap:12px; padding:14px 0; border-bottom:1px solid #f0f2f6;
}
#confirmModal .rezv__row:last-child{border-bottom:0;}
#confirmModal .rezv__label{color:#5b6472; font-weight:400; letter-spacing:.01em;}
#confirmModal .rezv__val{color:#0f172a; font-weight:600; text-align:right;}

/* Add “ Courts” after place name on DESKTOP only */
@media (min-width: 576px){
  #confirmModal .rezv__placeName::after{ content:" Courts"; }
}

/* Alignment helper */
#confirmModal .rezv__left{ --align-nudge: 10px; }

/* Place block (desktop defaults) */
#confirmModal .rezv__val--place{text-align:right;}
#confirmModal .rezv__placeLine{display:flex; align-items:center; justify-content:flex-end; gap:8px;}
#confirmModal .rezv__logo{height:18px; width:auto; opacity:.95;}
#confirmModal .rezv__placeName{font-weight:600; color:#111827;}
#confirmModal .rezv__addr{margin-top:2px; font-size:.9rem; color:#6b7280; font-weight:400;}
#confirmModal .addr-logo{display:none; height:14px; width:auto; margin-right:6px; vertical-align:baseline;}

/* Total row */
#confirmModal .rezv__row--total{
  position:relative; padding:14px 12px; margin-top:8px; margin-bottom:12px;
  background:linear-gradient(180deg,#f7f8ff,#f3f5ff);
  border:0; border-radius:10px; isolation:isolate; white-space:nowrap;
}
#confirmModal .rezv__row--total::after{content:""; position:absolute; inset:0; border:1px solid #dfe3ff; border-radius:10px; pointer-events:none;}
#confirmModal .rezv__row--total.rezv__align-left{margin-left:calc(-1 * var(--align-nudge)); width:calc(100% + var(--align-nudge));}
#confirmModal .rezv__val--accent{color:#3a38d6; font-weight:700; display:inline-flex; align-items:center; justify-content:flex-end;}

/* Note */
#confirmModal .rezv__noteArea{margin-top:auto; display:flex; flex-direction:column; gap:6px; min-height:140px;}
#confirmModal .rezv__noteLbl{display:block; color:#475467; font-weight:520; font-size:.9rem;}
#confirmModal .rezv__note{border:1px solid #e7e9f1; border-radius:12px; font-size:.94rem; min-height:44px; height:100%; resize:none;}
#confirmModal .rezv__note::placeholder{color:#98a2b3; font-size:0.82rem; opacity:0.9;}
#confirmModal .rezv__note.rezv__align-left{margin-left:calc(-1 * var(--align-nudge)); width:calc(100% + var(--align-nudge));}

/* Right side image */
#confirmModal .rezv__right{display:flex; min-height:100%;}
#confirmModal .rezv__grid{ --media-h: 520px; }
#confirmModal .rezv__media{position:relative; border:1px solid #eef1f6; border-radius:12px; overflow:hidden; background:#fafbff; flex:1 1 auto; height: var(--media-h);}
#confirmModal .rezv__photo{ width:100%; height:100%; object-fit:cover; }
@media (max-width: 991.98px){ #confirmModal .rezv__media{ height:auto; } #confirmModal .rezv__photo{ height:auto; aspect-ratio: 3 / 2; } }

#confirmModal .rezv__badge{position:absolute; right:12px; top:12px; padding:.28rem .6rem; border-radius:999px; background:#111827; color:#fff; font-size:.82rem; font-weight:600; opacity:.95;}

/* Footer */
#confirmModal .rezv__ftr{position:sticky; bottom:0; z-index:2; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 20px; border-top:1px solid #eef1f6; background:linear-gradient(180deg, rgba(255,255,255,.94), #fff);}
#confirmModal .rezv__ftr .btn-light{ margin-left:-9px; }
#confirmModal .rezv__ftr .btn-accent i.fa-cart-shopping{ font-size:.8rem; margin-top:1px; }

/* ========= MOBILE-ONLY TWEAKS ========= */
@media (max-width: 575.98px){
  #confirmModal .rezv__noteArea {
    grid-area: note;
    min-height: 100px;
    margin-top: -26px;     /* ⬅ tighter above */
    margin-bottom: 6px;  /* ⬅ tighter below */
  }
  /* tighter “Sumár” */
  #confirmModal .rezv__sec{ margin:2px 0 6px; }

  /* more room for values */
  #confirmModal .rezv__row{ --label-w:120px; gap:8px; }

  /* make the address block smaller on mobile */
  #confirmModal .rezv__placeLine{ display:none; }  /* hide desktop header line */
  #confirmModal .rezv__val--place{ text-align:right; }
  #confirmModal .addr-logo{ display:inline-block; height:14px; margin-right:6px; opacity:.95; position:relative; top:1px; }
  #confirmModal .addr-name{ font-weight:700; color:#111827; font-size:.9rem; }
  #confirmModal .addr-street,
  #confirmModal .addr-area,
  #confirmModal .addr-zip {
    font-weight:400;
    color:#6b7280;
    font-size:.72rem;
    line-height:0.35; /* reduced line spacing */
  }

  /* order: sec -> list (with price) -> NOTE -> IMAGE */
  #confirmModal .rezv__grid{
    display:grid;
    grid-template-columns:1fr;
    grid-template-areas:
      "sec"
      "list"
      "note"
      "media";
    row-gap:14px;
  }
  #confirmModal .rezv__left{ display:contents; }
  #confirmModal .rezv__sec{ grid-area:sec; }
  #confirmModal .rezv__list{ grid-area:list; }
  #confirmModal .rezv__noteArea{ grid-area:note; min-height:110px; }
  #confirmModal .rezv__right{ grid-area:media; }

  /* keep total on one line; align edges */
  #confirmModal .rezv__left{ --align-nudge:10px; }
  #confirmModal .rezv__row--total{ white-space:nowrap; padding-right:4px; }
  #confirmModal .rezv__row--total.rezv__align-left{ margin-left:calc(-1 * var(--align-nudge)); width:calc(100% + var(--align-nudge)); }
  #confirmModal .rezv__note.rezv__align-left{ margin-left:calc(-1 * var(--align-nudge)); width:calc(100% + var(--align-nudge)); }

  /* image alignment */
  #confirmModal .rezv__media{ margin-left:-10px; width:calc(100% + 10px); margin-top:-8px; }

  /* short button labels */
  #confirmModal .lbl-dt{ display:none; }
  #confirmModal .lbl-mob{ display:inline; }
}

/* desktop labels default */
@media (min-width: 576px){
  #confirmModal .lbl-dt{ display:inline; }
  #confirmModal .lbl-mob{ display:none; }
}
</style>

<!-- ================= JS: keep badge text in sync with court ================= -->
<script>
/* ============================================================
   === UNIVERSAL HELPERS ======================================
   ============================================================ */

// Convert "13. 10. 2025" → "2025-10-13"
function parseSkDateToISO(sk) {
  const m = String(sk || "").match(/^\s*(\d{1,2})\.\s*(\d{1,2})\.\s*(\d{4})\s*$/);
  if (!m) return null;
  const [_, d, mo, y] = m;
  return `${y}-${mo.padStart(2,"0")}-${d.padStart(2,"0")}`;
}

// Get ISO date from modal label or input
function getISODate() {
  const input = document.querySelector('input[type="date"], #datePicker, [data-role="date-input"]');
  if (input?.value) return input.value;
  const lbl = document.getElementById("mDate");
  if (lbl?.textContent) {
    const iso = parseSkDateToISO(lbl.textContent.trim());
    if (iso) return iso;
  }
  return window.currentDate || null;
}

// Get selected court id
function getCourtId() {
  const modal = document.getElementById("confirmModal");
  if (modal?.dataset?.court) return String(modal.dataset.court);
  if (window.currentCourtId) return String(window.currentCourtId);

  const label = document.getElementById("mCourt");
  const badge = document.getElementById("mCourtBadge");
  const txt = (label?.textContent || badge?.textContent || "").trim();
  const m = txt.match(/(\d{1,2})/);
  return m ? m[1] : null;
}

// Show alert (replace with nicer banner if you want)
function showErrorBanner(msg) { alert(msg); }

// Safe JSON parser
async function parseJsonSafe(res) {
  const ct = res.headers.get("content-type") || "";
  if (ct.includes("application/json")) return res.json();
  const txt = await res.text();
  try { return JSON.parse(txt); } catch { return { ok:false, error:txt || `HTTP ${res.status}` }; }
}

/* ============================================================
   === MODAL INITIALIZATION ====================================
   ============================================================ */

// Called before showing modal
function setModalCourt(courtId) {
  const modal = document.getElementById("confirmModal");
  if (!modal) return;
  modal.dataset.court = String(courtId);

  const mCourt = document.getElementById("mCourt");
  const badge  = document.getElementById("mCourtBadge");
  if (mCourt) mCourt.textContent = `Kurt ${courtId}`;
  if (badge)  badge.textContent  = `Kurt ${courtId}`;
}

// Called when user selects time range on main page
function setModalTimeAndTotal(start, end, total) {
  document.getElementById("mTime").textContent = `${start} – ${end}`;
  document.getElementById("mTotal").textContent = total || "15,00 €";
  // store slot info globally
  window.selectedSlots = buildSlotArray(start, end);
}

// Build slot array e.g. "14:30"–"15:30" => ["14:30","15:00"]
function buildSlotArray(start, end) {
  const toMin = s => parseInt(s.slice(0,2))*60 + parseInt(s.slice(3,5));
  const toStr = m => `${String(Math.floor(m/60)).padStart(2,"0")}:${String(m%60).padStart(2,"0")}`;
  const out = [];
  for (let m = toMin(start); m < toMin(end); m += 30) out.push(toStr(m));
  return out;
}

// Fallback if slots not set globally
function getSelectedSlots() {
  if (Array.isArray(window.selectedSlots) && window.selectedSlots.length)
    return window.selectedSlots;
  const t = (document.getElementById("mTime")?.textContent || "").trim();
  const m = t.match(/(\d{2}:\d{2}).*?(\d{2}:\d{2})/);
  return m ? buildSlotArray(m[1], m[2]) : [];
}

/* ============================================================
   === BOOKING FLOW ============================================
   ============================================================ */

async function confirmBooking() {
  const payload = {
    date:  getISODate(),
    court: getCourtId(),
    slots: getSelectedSlots(),
    name:  "",
    email: ""
  };

  console.log("[confirmBooking] payload:", payload);

  if (!payload.date)  return showErrorBanner("Chýba dátum.");
  if (!payload.court) return showErrorBanner("Chýba alebo je neplatný kurt.");
  if (!payload.slots.length) return showErrorBanner("Nevybrali ste čas.");

  try {
    const res = await fetch("/api/book", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      credentials: "same-origin"
    });
    const data = await parseJsonSafe(res);
    console.log("[confirmBooking] response:", data);

    if (!res.ok || !data.ok)
      throw new Error(data.error || `HTTP ${res.status}`);

    // redirect to checkout
    const q = new URLSearchParams({
      date: data.date,
      court: data.court,
      total: (document.getElementById("mTotal")?.textContent || "15,00 €").trim(),
      time:  (document.getElementById("mTime")?.textContent || "").trim()   // <— add this
    });
    window.location.href = `/checkout?${q.toString()}`;

  } catch (err) {
    console.error("Booking failed:", err);
    showErrorBanner(err.message || "Chyba spojenia. Skúste znova.");
  }
}

/* ============================================================
   === EVENT BINDINGS ==========================================
   ============================================================ */

// Example — when user clicks to open modal for a specific court/time
// You can adjust this to your real logic
document.querySelectorAll("[data-court][data-start][data-end]").forEach(btn => {
  btn.addEventListener("click", () => {
    const court = btn.dataset.court;
    const start = btn.dataset.start;
    const end   = btn.dataset.end;
    const total = btn.dataset.total || "15,00 €";
    setModalCourt(court);
    setModalTimeAndTotal(start, end, total);
    new bootstrap.Modal(document.getElementById("confirmModal")).show();
  });
});

// Confirm button → booking
document.getElementById("modalConfirmBtn")?.addEventListener("click", confirmBooking);
</script>